<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lemur App - AI-powered Search Platform</title>
  
  <!-- Avoid CSP issues with frame embedding -->
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors *; default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://* wss://*;">
  
  <style>
    /* Fallback loading styles */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.5;
      color: #111827;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }
    
    #fallback {
      display: none;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
    }
    
    .card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      margin-bottom: 1.5rem;
    }
    
    h1 {
      color: #4338ca;
      margin-bottom: 1rem;
    }
    
    button {
      background: #4338ca;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
    }
    
    pre {
      background: #1f2937;
      color: #e5e7eb;
      padding: 1rem;
      border-radius: 0.25rem;
      overflow: auto;
      max-height: 300px;
    }
    
    .loader {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(67, 56, 202, 0.3);
      border-radius: 50%;
      border-top-color: #4338ca;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .success { color: #059669; font-weight: bold; }
    .error { color: #dc2626; font-weight: bold; }
    
    /* Show fallback if app doesn't load within 5s */
    .load-timeout #fallback { display: block; }
    .load-timeout #root { display: none; }
  </style>
</head>
<body>
  <div id="root">
    <!-- App will render here -->
  </div>
  
  <!-- Fallback content that shows if the app doesn't load -->
  <div id="fallback">
    <h1>Lemur App - Loading Diagnostics</h1>
    
    <div class="card">
      <h2>Application Status</h2>
      <p id="app-status">
        <span class="loader"></span>
        Checking application status...
      </p>
      <div id="error-details" style="display: none;"></div>
      <button id="retry-button" style="display: none;">Retry Loading App</button>
    </div>
    
    <div class="card">
      <h2>Server Connection Test</h2>
      <p>This tests if the application server is accessible:</p>
      <button id="test-server-btn">Test Server Connection</button>
      <div id="server-result" style="margin-top: 1rem;"></div>
    </div>
    
    <div class="card">
      <h2>Environment Information</h2>
      <p>The following information helps diagnose connection issues:</p>
      <pre id="env-info"></pre>
    </div>
  </div>

  <!-- Main application script -->
  <script type="module" src="/src/main.tsx"></script>

  <!-- Error Detection and Diagnostics Script -->
  <script>
    // Environment information
    const envInfo = {
      url: window.location.href,
      hostname: window.location.hostname,
      protocol: window.location.protocol,
      userAgent: navigator.userAgent,
      isOnline: navigator.onLine,
      timestamp: new Date().toISOString(),
      viewportWidth: window.innerWidth,
      viewportHeight: window.innerHeight
    };
    
    // Log environment info to console
    console.log('Environment Info:', envInfo);
    
    // Global error handler
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      document.body.classList.add('load-timeout');
      document.getElementById('app-status').innerHTML = 
        `<span class="error">❌ Error loading application</span>`;
      document.getElementById('error-details').style.display = 'block';
      document.getElementById('error-details').innerHTML = 
        `<p>Error: ${e.error || e.message}</p>
         <p>File: ${e.filename}, Line: ${e.lineno}, Column: ${e.colno}</p>`;
      document.getElementById('retry-button').style.display = 'block';
      document.getElementById('env-info').textContent = JSON.stringify(envInfo, null, 2);
    });
    
    // Show fallback UI if app doesn't load within 5 seconds
    const loadTimeout = setTimeout(() => {
      if (!window.appLoaded) {
        console.log('Application load timeout - showing diagnostics');
        document.body.classList.add('load-timeout');
        document.getElementById('app-status').innerHTML = 
          `<span class="error">⚠️ Application did not load within expected time</span>`;
        document.getElementById('retry-button').style.display = 'block';
        document.getElementById('env-info').textContent = JSON.stringify(envInfo, null, 2);
      }
    }, 5000);
    
    // Set flag when app loaded
    window.addEventListener('DOMContentLoaded', () => {
      // Wait for React to mount
      setTimeout(() => {
        if (document.getElementById('root').children.length > 0) {
          window.appLoaded = true;
          clearTimeout(loadTimeout);
          console.log('Application loaded successfully');
        }
      }, 1000);
    });
    
    // Retry button
    document.getElementById('retry-button').addEventListener('click', () => {
      window.location.reload();
    });
    
    // Test server connection button
    document.getElementById('test-server-btn').addEventListener('click', async function() {
      const resultDiv = document.getElementById('server-result');
      resultDiv.innerHTML = '<span class="loader"></span> Testing connection...';

      try {
        const response = await fetch('/test');
        
        if (response.ok) {
          const data = await response.json();
          resultDiv.innerHTML = `
            <p class="success">✅ Connection successful!</p>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML = `
            <p class="error">❌ Server responded with status: ${response.status}</p>
            <p>Response text: ${await response.text() || '[Empty response]'}</p>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <p class="error">❌ Connection failed!</p>
          <p>Error: ${error.message}</p>
          <p>Make sure the server is running and properly configured.</p>
        `;
      }
    });

    // Replit environment handling
    const isReplit = window.location.hostname.includes('replit');
    if (isReplit) {
      console.log('Running in Replit environment - enabling special handling');
      
      // Add Replit info to environment details
      envInfo.isReplit = true;
      document.getElementById('env-info').textContent = JSON.stringify(envInfo, null, 2);
      
      // Override fetch to add CORS headers for all requests
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        console.log('Fetch request:', args[0]);
        
        // If it's a Request object, clone it and modify
        if (args[0] instanceof Request) {
          const request = args[0].clone();
          const newHeaders = new Headers(request.headers);
          newHeaders.set('X-Requested-From', window.location.origin);
          
          const newRequest = new Request(request, {
            headers: newHeaders,
            mode: 'cors',
            credentials: 'include'
          });
          
          args[0] = newRequest;
        }
        // If it's a URL string and options
        else if (typeof args[0] === 'string' && args[1]) {
          args[1] = {
            ...args[1],
            mode: 'cors',
            credentials: 'include',
            headers: {
              ...args[1]?.headers,
              'X-Requested-From': window.location.origin
            }
          };
        }
        
        return originalFetch.apply(this, args)
          .then(response => {
            console.log('Fetch response:', response.status, response.url);
            return response;
          })
          .catch(err => {
            console.error('Fetch error:', err);
            throw err;
          });
      };
    }
  </script>
</body>
</html>